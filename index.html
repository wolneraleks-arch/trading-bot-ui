<!-- <!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Redirecting...</title>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
</head>
<body>
    <script>
        // 1. Инициализация ВК
        vkBridge.send("VKWebAppInit", {});

        // 2. Ссылка на ваше развернутое веб-приложение Google Apps Script
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx1RtFb9o-XMooNAFgD-tnnDeprncLYvSzfxveWmsFa9H2-ZXUo4Gp6G10i9BvpHd6cgA/exec";

        // 3. Перенаправление со всеми параметрами (vk_user_id и т.д.)
        const currentParams = window.location.search;
        window.location.href = GAS_URL + currentParams;
    </script>
</body>
</html> -->


<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; color: #444; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button { background: #0077ff; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="card">
    <h3 id="title">Загрузка...</h3>
    <p id="status">Проверяем доступ</p>
    <div id="content" style="display:none">
        <p>Ваши тикеры: <b id="tickers"></b></p>
        <button onclick="buySubscription()">Продлить подписку</button>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbx1RtFb9o-XMooNAFgD-tnnDeprncLYvSzfxveWmsFa9H2-ZXUo4Gp6G10i9BvpHd6cgA/exec"; 

    async function start() {
        const title = document.getElementById('title');
        const statusText = document.getElementById('status');

        try {
            await vkBridge.send("VKWebAppInit");
            const urlParams = new URLSearchParams(window.location.search);
            const vkId = urlParams.get('vk_user_id');

            if (!vkId) {
                title.innerText = "Ошибка";
                statusText.innerText = "Запустите из ВК";
                return;
            }

            // Имитируем статус из Трибута (позже заменим на реальную проверку)
            const tributeStatus = "active"; 

            // Запрос к GAS
            const requestUrl = `${GAS_URL}?action=check_or_register&vk_id=${vkId}&tribute_status=${tributeStatus}`;
            
            const response = await fetch(requestUrl);
            if (!response.ok) throw new Error("Сеть не ответила");
            
            const result = await response.json();

            if (result.status === "guest") {
                title.innerText = "Доступ ограничен";
                statusText.innerText = "Оплатите подписку, чтобы бот начал работать.";
            } else {
                title.innerText = "Настройки";
                statusText.innerText = "Подписка: " + (result.data.active === "Да" ? "Активна ✅" : "Истекла ❌");
                document.getElementById('tickers').innerText = result.data.tickers;
                document.getElementById('content').style.display = "block";
            }

        } catch (err) {
            title.innerText = "Ошибка связи";
            statusText.innerText = "Не удалось соединиться с таблицей. Проверьте деплой GAS.";
            console.error(err);
        }
    }

    start();
</script>

</body>
</html>









